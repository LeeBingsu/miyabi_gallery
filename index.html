<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BBH+Sans+Bartle&display=swap" rel="stylesheet">
    <title>Miygal</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <!-- zip.js Library with Password Support -->
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.72/dist/zip-full.min.js"></script>

    <style>
        /* ... 기존 CSS 그대로 ... */
        /* ===== 완벽한 이미지/뷰어 ===== */
        #lightbox-content { width: 100%; height: calc(100vh - 120px) !important; display: flex !important; align-items: center !important; justify-content: center !important; overflow: hidden !important; }
        #lightbox-content img { max-width: 100% !important; max-height: calc(100vh - 120px) !important; width: auto !important; height: auto !important; object-fit: contain !important; display: block !important; }
    </style>
</head>
<body>
    <!-- 나머지 본문은 기존 그대로 유지 -->

    <script>
        /* ... 기존 스크립트 그대로 ... */

        // 썸네일 onerror 폴백 (없으면 추가)
        function handleThumbnailError(img, isVideo){
          if(img.dataset.fallbackApplied) return;
          img.dataset.fallbackApplied = '1';
          img.parentElement.innerHTML = isVideo
            ? '<div style="width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;border-radius:8px">▶</div>'
            : '<div style="width:100%;height:100%;background:linear-gradient(135deg,#ff6b6b,#ee5a24);display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;border-radius:8px">📷</div>';
        }

        // 기존 openLightbox 내부의 썸네일 경로 계산 부분만 최소 수정
        function openLightbox(imgSrc, mediaKey) {
            const lightbox = document.getElementById('lightbox');
            const content = document.getElementById('lightbox-content');
            const gallery = document.getElementById('thumbnailGallery');
            const items = Array.from(document.querySelectorAll('.gallery-item'));
            allMediaKeys = items.map(i => i.dataset.key);
            if (mediaKey) currentMediaIndex = allMediaKeys.indexOf(mediaKey);
            const vExts = ['.mp4', '.webm', '.ogg', '.mov', '.avi'];
            const isV = vExts.some(e => imgSrc.toLowerCase().endsWith(e));
            content.innerHTML = isV ? '<video src="' + imgSrc + '" controls autoplay loop style="max-width:100%;max-height:calc(100vh - 120px)"></video>' : '<img src="' + imgSrc + '" style="max-width:100%;height:auto;cursor:pointer" onclick="toggleImageZoom(this)">';
            gallery.innerHTML = '';
            allMediaKeys.forEach((k, i) => {
                const d = document.createElement('div');
                d.className = 'thumbnail-item' + (i === currentMediaIndex ? ' active' : '');
                const isTV = vExts.some(e => k.toLowerCase().endsWith(e));
                const fileName = k.split('/').pop();
                const folderPath = k.includes('/') ? k.substring(0, k.lastIndexOf('/')) : '';
                const ts = isTV
                    ? `${WORKER_URL}/api/image/.thumbnails/${folderPath ? folderPath + '/' : ''}${fileName}.jpg`
                    : `${WORKER_URL}/api/image/${k}`;
                d.innerHTML = isTV
                    ? `<img src="${ts}" loading="lazy" onerror="handleThumbnailError(this,true)"><div class="video-icon">▶</div>`
                    : `<img src="${ts}" loading="lazy" onerror="handleThumbnailError(this,false)">`;
                d.onclick = e => { e.stopPropagation(); jumpToMedia(i); };
                gallery.appendChild(d);
            });
            scrollToActiveThumbnail();
            lightbox.classList.add('active');
        }
    </script>
</body>
</html>
