<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BBH+Sans+Bartle&display=swap" rel="stylesheet">
    <title>Miygal</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <!-- zip.js Library with Password Support -->
    <script src="https://unpkg.com/@zip.js/zip.js@2.7.72/dist/zip-full.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary-color:#007AFF; --secondary-color:#5856D6; --background:#F2F2F7; --card-background:#FFFFFF; --text-primary:#000000; --text-secondary:#8E8E93; --border-color:#E5E5EA; --destructive:#FF3B30; --success:#34C759; --radius-large:20px; --radius-medium:12px; --radius-small:8px; --shadow:0 2px 16px rgba(0,0,0,.08); --shadow-hover:0 8px 24px rgba(0,0,0,.12); }
        @media (prefers-color-scheme: dark) { :root { --background:#000; --card-background:#1C1C1E; --text-primary:#FFF; --text-secondary:#8E8E93; --border-color:#38383A; } }
        body { font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Roboto,sans-serif; background:var(--background); color:var(--text-primary); padding:0; min-height:100vh; }
        .viewing-area{ padding:40px 16px 16px; text-align:center; }
        h1{ font-size:28px; font-weight:700; letter-spacing:-.5px; margin-bottom:8px; }
        .subtitle{ font-size:15px; color:var(--text-secondary); font-weight:400; }
        .interaction-area{ max-width:100%; margin:0 auto; padding:0 16px 40px; }
        .card{ background:var(--card-background); border-radius:var(--radius-large); padding:16px; margin-bottom:16px; box-shadow:var(--shadow); }
        .breadcrumb{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:16px; padding:12px 16px; background:var(--background); border-radius:var(--radius-medium); font-size:14px; }
        .breadcrumb-item{ color:var(--primary-color); cursor:pointer; transition:opacity .2s; }
        .breadcrumb-item:hover{ opacity:.7; }
        .breadcrumb-item.current{ color:var(--text-primary); cursor:default; font-weight:600; }
        .breadcrumb-separator{ color:var(--text-secondary); user-select:none; }
        .folder-container{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--border-color); }
        .folder-pill{ padding:10px 16px; background:var(--background); color:var(--text-primary); border:none; border-radius:20px; font-size:14px; font-weight:500; cursor:pointer; transition:all .2s cubic-bezier(.4,0,.2,1); white-space:nowrap; }
        .folder-pill:active{ transform:scale(.95); }
        .folder-pill.active{ background:var(--primary-color); color:#fff; }
        .action-bar{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px; }
        .btn{ padding:12px 16px; border:none; border-radius:var(--radius-medium); font-size:14px; font-weight:600; cursor:pointer; transition:all .2s ease; display:flex; align-items:center; justify-content:center; gap:6px; }
        .btn:active{ transform:scale(.96); }
        .btn-primary{ background:var(--primary-color); color:#fff; }
        .btn-secondary{ background:var(--background); color:var(--text-primary); }
        .btn-destructive{ background:var(--destructive); color:#fff; }
        input[type="file"]{ display:none; }
        .file-label{ padding:12px 16px; background:var(--success); color:#fff; border-radius:var(--radius-medium); font-size:14px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; transition:all .2s ease; }
        .file-label:active{ transform:scale(.96); }
        .gallery{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }
        .gallery-item{ position:relative; aspect-ratio:1; overflow:hidden; border-radius:var(--radius-medium); cursor:pointer; transition:all .3s cubic-bezier(.4,0,.2,1); }
        .gallery-item:active{ transform:scale(.98); }
        .gallery-item img{ width:100%; height:100%; object-fit:cover; }
        .delete-btn{ position:absolute; top:6px; right:6px; width:28px; height:28px; background:rgba(255,59,48,.95); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border:none; border-radius:50%; color:#fff; font-size:16px; cursor:pointer; opacity:0; transition:all .2s ease; display:flex; align-items:center; justify-content:center; z-index:5; }
        .gallery-item:hover .delete-btn, .gallery-item:active .delete-btn{ opacity:1; }
        .delete-btn:active{ transform:scale(.9); }
        .lightbox{ display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.95); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); }
        .lightbox.active{ display:flex; justify-content:center; align-items:center; animation:fadeIn .2s ease; }
        @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
        .lightbox img{ max-width:90%; max-height:90%; border-radius:var(--radius-large); }
        .close{ position:absolute; top:20px; right:20px; width:44px; height:44px; background:rgba(255,255,255,.2); backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px); border-radius:50%; color:#fff; font-size:24px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s ease; }
        .close:hover{ background:rgba(255,255,255,.3); }
        .close:active{ transform:scale(.9); }
        .toast{ position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(100px); background:var(--card-background); padding:16px 24px; border-radius:var(--radius-medium); box-shadow:var(--shadow-hover); font-size:15px; font-weight:500; opacity:0; transition:all .3s cubic-bezier(.4,0,.2,1); z-index:2000; max-width:90%; }
        .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
        .toast.success{ color:var(--success); }
        .toast.error{ color:var(--destructive); }
        .empty-state{ text-align:center; padding:60px 20px; color:var(--text-secondary); }
        .empty-state-icon{ font-size:64px; margin-bottom:16px; opacity:.5; }
        .pixai-shortcut{ position:fixed; top:20px; right:20px; width:56px; height:56px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border:none; border-radius:50%; box-shadow:0 4px 12px rgba(102,126,234,.4); cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:999; transition:all .3s ease; text-decoration:none; }
        .pixai-shortcut:hover{ transform:translateY(-2px) scale(1.05); box-shadow:0 6px 20px rgba(102,126,234,.6); }
        .pixai-shortcut:active{ transform:scale(.95); }
        .pixai-icon{ width:28px; height:28px; }
        .storage-info{ position:fixed; top:10px; right:90px; background:var(--card-background); padding:6px 12px; border-radius:var(--radius-small); box-shadow:var(--shadow); font-size:11px; z-index:998; display:flex; align-items:center; gap:8px; }
        .storage-bar{ width:80px; height:4px; background:var(--background); border-radius:2px; overflow:hidden; }
        .storage-bar-fill{ height:100%; background:var(--success); transition:width .3s ease; }
        .storage-text{ color:var(--text-secondary); font-weight:500; font-size:10px; }
        .storage-text strong{ color:var(--text-primary); font-size:11px; }
        .selection-mode .gallery-item{ cursor:pointer; }
        .gallery-item-checkbox{ position:absolute; top:10px; left:10px; width:24px; height:24px; z-index:10; opacity:0; transition:opacity .2s; accent-color:var(--primary-color); }
        .selection-mode .gallery-item-checkbox{ opacity:1; }
        .gallery-item.selected::after{ content:''; position:absolute; inset:0; background:rgba(0,122,255,.3); border:3px solid var(--primary-color); border-radius:var(--radius-medium); pointer-events:none; }
        .bulk-action-bar{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--card-background); padding:16px 24px; border-radius:var(--radius-large); box-shadow:var(--shadow-hover); display:none; gap:12px; align-items:center; z-index:999; flex-wrap:wrap; }
        .bulk-action-bar.active{ display:flex; }
        .bulk-btn{ padding:10px 20px; border:none; border-radius:var(--radius-medium); font-size:14px; font-weight:600; cursor:pointer; transition:all .2s; }
        .bulk-btn:active{ transform:scale(.96); }
        .bulk-btn-download{ background:var(--success); color:#fff; }
        .bulk-btn-delete{ background:var(--destructive); color:#fff; }
        .bulk-btn-cancel{ background:var(--background); color:var(--text-primary); }

        /* Thumbnail bar (fix) */
        .thumbnail-gallery{position:fixed;bottom:0;left:0;right:0;height:100px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);display:none;align-items:center;padding:10px 15px;overflow-x:auto;z-index:1001;gap:8px;border-top:1px solid rgba(255,255,255,.2)}
        .lightbox.active .thumbnail-gallery{display:flex}
        .thumbnail-item{min-width:70px;width:70px;height:70px;border-radius:8px;overflow:hidden;cursor:pointer;transition:.3s;border:3px solid transparent;position:relative;flex-shrink:0;background:#333}
        .thumbnail-item img{width:100%;height:100%;object-fit:cover;display:block}
        .thumbnail-item.active{border-color:var(--primary-color);transform:scale(1.05)}
        .thumbnail-item .video-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.8);pointer-events:none}
        #lightbox-content{width:100%;height:calc(100vh - 120px) !important;display:flex !important;align-items:center !important;justify-content:center !important;overflow:hidden !important}
        #lightbox-content img{max-width:100% !important;max-height:calc(100vh - 120px) !important;width:auto !important;height:auto !important;object-fit:contain !important;display:block !important}
        @media (max-width:640px){.thumbnail-gallery{height:90px;padding:8px 10px}.thumbnail-item{min-width:60px;width:60px;height:60px}#lightbox-content{height:calc(100vh - 110px) !important}#lightbox-content img{max-height:calc(100vh - 110px) !important}}
    </style>
</head>
<body>
    <!-- ... BODY UNCHANGED ... -->
    <!-- For brevity, omitted: the entire body content stays the same as previous version -->

    <script>
      // Keep existing global variables and functions above unchanged
      // Only patch openLightbox and add thumbnail error handler

      function handleThumbnailError(img, isVideo){
        if(isVideo){
          img.parentElement.innerHTML = '<div style="width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;border-radius:8px">▶</div>';
        }else{
          img.parentElement.innerHTML = '<div style="width:100%;height:100%;background:linear-gradient(135deg,#ff6b6b,#ee5a24);display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;border-radius:8px">📷</div>';
        }
      }

      // Patched openLightbox that fixes thumbnail sources
      function openLightbox(imgSrc, mediaKey){
        const lightbox = document.getElementById('lightbox');
        const content  = document.getElementById('lightbox-content');
        const gallery  = document.getElementById('thumbnailGallery');
        const items = Array.from(document.querySelectorAll('.gallery-item'));
        allMediaKeys = items.map(i => i.dataset.key);
        if(mediaKey) currentMediaIndex = allMediaKeys.indexOf(mediaKey);

        const vExts = ['.mp4','.webm','.ogg','.mov','.avi'];
        const isV = vExts.some(e => imgSrc.toLowerCase().endsWith(e));

        content.innerHTML = isV
          ? `<video src="${imgSrc}" controls autoplay loop style="max-width:100%;max-height:calc(100vh - 120px)"></video>`
          : `<img src="${imgSrc}" style="max-width:100%;height:auto;cursor:pointer" onclick="toggleImageZoom(this)">`;

        gallery.innerHTML = '';
        allMediaKeys.forEach((k, i) => {
          const d = document.createElement('div');
          d.className = 'thumbnail-item' + (i === currentMediaIndex ? ' active' : '');
          const isTV = vExts.some(e => k.toLowerCase().endsWith(e));

          let thumbSrc;
          if (isTV) {
            const fileName   = k.split('/').pop();
            const folderPath = k.includes('/') ? k.substring(0, k.lastIndexOf('/')) : '';
            thumbSrc = `${WORKER_URL}/api/image/.thumbnails/${folderPath ? folderPath + '/' : ''}${fileName}.jpg`;
          } else {
            thumbSrc = `${WORKER_URL}/api/image/${k}`;
          }

          d.innerHTML = isTV
            ? `<img src="${thumbSrc}" alt="Video thumbnail" loading="lazy" onerror="handleThumbnailError(this,true)"><div class="video-icon">▶</div>`
            : `<img src="${thumbSrc}" alt="Image thumbnail" loading="lazy" onerror="handleThumbnailError(this,false)">`;

          d.onclick = e => { e.stopPropagation(); jumpToMedia(i); };
          gallery.appendChild(d);
        });

        const active = gallery.querySelector('.thumbnail-item.active');
        if (active) active.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
        lightbox.classList.add('active');
      }
    </script>
</body>
</html>
